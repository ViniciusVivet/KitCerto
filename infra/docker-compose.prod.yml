# Backend em produção (sem frontend – frontend na Vercel).
# Uso: cp .env.example .env && edite .env depois:
#   docker compose -f docker-compose.prod.yml --env-file .env up -d

services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval \"quit(db.runCommand({ ping: 1 }).ok === 1 ? 0 : 1)\""]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 30s

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak -h localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: ["start", "--http-port=8080", "--http-enabled=true", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_PROXY_HEADERS: xforwarded
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME: "3.15.32.160"
      KC_HOSTNAME_PATH: "/auth"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
    volumes:
      - ./keycloak/realm-kitcerto.json:/opt/keycloak/data/import/realm-kitcerto.json:ro
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  api:
    build:
      context: ..
      dockerfile: backend/KitCerto.API/Dockerfile
    depends_on:
      mongo:
        condition: service_healthy
      keycloak:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: "Production"
      ASPNETCORE_URLS: "http://0.0.0.0:5000"
      ConnectionStrings__Mongo: "mongodb://mongo:27017/kitcerto"
      Auth__Authority: "${KEYCLOAK_PUBLIC_URL}/realms/kitcerto"
      Auth__Audience: "kitcerto-api"
      Auth__RequireHttpsMetadata: "false"
      Cors__Origins: "${FRONTEND_URL}"
      MercadoPago__AccessToken: ${MP_ACCESS_TOKEN:-}
      MercadoPago__Sandbox: ${MP_SANDBOX:-true}
      MercadoPago__SuccessUrl: ${MP_SUCCESS_URL}
      MercadoPago__FailureUrl: ${MP_FAILURE_URL}
      MercadoPago__PendingUrl: ${MP_PENDING_URL}
      MercadoPago__NotificationUrl: ${MP_NOTIFICATION_URL:-}
      Storage__Provider: ${Storage__Provider:-local}
      Storage__S3__Bucket: ${Storage__S3__Bucket:-}
      Storage__S3__Region: ${Storage__S3__Region:-}
      Storage__S3__BaseUrl: ${Storage__S3__BaseUrl:-}
      Storage__S3__PublicRead: ${Storage__S3__PublicRead:-true}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-}
    volumes:
      - ./data/uploads:/app/wwwroot/uploads
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.simple.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api
      - keycloak
    restart: unless-stopped

volumes:
  mongo_data:
  pg_data:
