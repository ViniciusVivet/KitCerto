services:
  # ---------- Mongo ----------
  mongo:
    image: mongo:6
    container_name: kitcerto-mongo-dev
    ports:
      - "27017:27017"
    volumes:
      - mongo_data_dev:/data/db
    restart: unless-stopped

  # ---------- Postgres (DB do Keycloak) ----------
  postgres:
    image: postgres:16-alpine
    container_name: kitcerto-postgres-dev
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - pg_data_dev:/var/lib/postgresql/data
    restart: unless-stopped

  # ---------- Keycloak ----------
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: kitcerto-keycloak-dev
    command: ["start-dev", "--http-port=8080", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_URL: http://localhost:8080
    volumes:
      - ./infra/keycloak/realm-kitcerto.json:/opt/keycloak/data/import/realm-kitcerto.json:ro
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    restart: unless-stopped

  # ---------- API (.NET Watch) ----------
  api:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    container_name: kitcerto-api-dev
    working_dir: /src
    command: dotnet watch run --project backend/KitCerto.API/KitCerto.API.csproj --urls "http://0.0.0.0:5000"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__Mongo: "mongodb://mongo:27017/kitcerto"
      Auth__Authority: "http://keycloak:8080/realms/kitcerto"
      Auth__Audience: "kitcerto-api"
      Auth__RequireHttpsMetadata: "false"
    volumes:
      - .:/src
      - ~/.aspnet/https:/root/.aspnet/https:ro
      - ~/.nuget/packages:/root/.nuget/packages
    ports:
      - "5000:5000"
    depends_on:
      - mongo
      - keycloak

  # ---------- Frontend (Next.js Dev) ----------
  frontend:
    image: node:20-alpine
    container_name: kitcerto-frontend-dev
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=/api
      - NEXT_PUBLIC_USE_MOCKS=false
      - NEXT_PUBLIC_KEYCLOAK_URL=http://localhost:8080
      - NEXT_PUBLIC_KEYCLOAK_REALM=kitcerto
      - NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=kitcerto-frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    ports:
      - "3000:3000"
    depends_on:
      - api

volumes:
  mongo_data_dev:
  pg_data_dev:
